name: Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run validation script
      run: npm run validate

    - name: Run tests
      run: npm test

    - name: Check TypeScript types
      run: npx tsc --noEmit --skipLibCheck

    - name: Run security audit
      run: npm audit --audit-level moderate

    - name: Check code coverage
      run: npm run test:coverage

    - name: Validate documentation
      run: |
        # Check if all required docs exist
        test -f README.md && echo "âœ… README.md exists"
        test -f docs/setup.md && echo "âœ… docs/setup.md exists"
        test -f docs/api.md && echo "âœ… docs/api.md exists"
        test -f docs/architecture.md && echo "âœ… docs/architecture.md exists"
        test -f docs/checklist.md && echo "âœ… docs/checklist.md exists"

    - name: Check project structure
      run: |
        # Validate manifest.yaml
        if command -v yq &> /dev/null; then
          yq eval '.modules | length' manifest.yaml | grep -q "5" && echo "âœ… 5 modules defined in manifest"
        fi
        
        # Check access policy
        test -f config/access_policy.yaml && echo "âœ… Access policy exists"

    - name: Performance benchmark
      run: |
        echo "ğŸ” Running performance benchmarks..."
        node -e "
          const startTime = Date.now();
          const { KGMemory } = require('./index.js');
          const kg = new KGMemory();
          
          // Test entity creation performance
          const entities = [];
          for (let i = 0; i < 100; i++) {
            entities.push({
              name: \`test-entity-\${i}\`,
              entityType: 'test',
              observations: [{ content: 'Test observation' }]
            });
          }
          
          kg.createEntities(entities).then(() => {
            const creationTime = Date.now() - startTime;
            console.log(\`âœ… Entity creation (100 entities): \${creationTime}ms\`);
            
            // Test search performance
            const searchStart = Date.now();
            kg.semanticSearch('test').then(() => {
              const searchTime = Date.now() - searchStart;
              console.log(\`âœ… Semantic search: \${searchTime}ms\`);
              
              // Memory usage check
              const memUsage = process.memoryUsage();
              console.log(\`âœ… Memory usage: \${Math.round(memUsage.heapUsed / 1024 / 1024)}MB\`);
              
              process.exit(0);
            });
          });
        "

    - name: Generate PR report
      run: |
        echo "ğŸ“Š Pull Request Validation Report"
        echo "=================================="
        echo "âœ… All validation checks passed"
        echo "âœ… Code quality standards met"
        echo "âœ… Security audit completed"
        echo "âœ… Performance benchmarks verified"
        echo "âœ… Documentation validated"
        echo "âœ… Project structure confirmed"
        echo ""
        echo "ğŸ¯ Ready for review and merge!"

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: validate-pr
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run integration tests
      run: npm run test:integration

    - name: Test workflow
      run: |
        echo "ğŸ”„ Testing complete workflow..."
        node -e "
          const { KGMemory } = require('./index.js');
          const kg = new KGMemory();
          
          // Test complete workflow: create â†’ tag â†’ search â†’ persist
          (async () => {
            try {
              // Create entity with auto-tagging
              const result = await kg.createEntities([{
                name: 'test-workflow',
                entityType: 'integration-test',
                observations: [{ content: 'This is a test for complete workflow' }]
              }]);
              
              console.log('âœ… Entity creation successful');
              
              // Test semantic search
              const searchResults = await kg.semanticSearch('test workflow');
              console.log('âœ… Semantic search successful');
              
              // Test tag search
              const tagResults = await kg.searchByTags(['integration-test']);
              console.log('âœ… Tag search successful');
              
              console.log('ğŸ‰ Complete workflow test passed!');
              process.exit(0);
            } catch (error) {
              console.error('âŒ Workflow test failed:', error.message);
              process.exit(1);
            }
          })();
        "

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    needs: validate-pr
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check documentation links
      run: |
        echo "ğŸ“š Validating documentation..."
        
        # Check README examples
        if grep -q "npm run test:bootstrap" README.md; then
          echo "âœ… README contains test examples"
        fi
        
        # Check API documentation completeness
        if grep -q "createEntities" docs/api.md && grep -q "semanticSearch" docs/api.md; then
          echo "âœ… API documentation complete"
        fi
        
        # Check setup instructions
        if grep -q "Windows\|macOS\|Linux" docs/setup.md; then
          echo "âœ… Platform-specific setup instructions"
        fi
        
        echo "ğŸ“š Documentation validation complete!"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-pr
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security audit
      run: npm audit --audit-level moderate

    - name: Check for secrets
      run: |
        echo "ğŸ” Checking for potential secrets..."
        
        # Check for common secret patterns
        if grep -r "api_key\|secret\|password\|token" --include="*.js" --include="*.json" . | grep -v "node_modules" | grep -v ".env"; then
          echo "âš ï¸  Potential secrets found in source code"
          exit 1
        else
          echo "âœ… No secrets found in source code"
        fi

    - name: Validate environment variables
      run: |
        echo "ğŸ” Validating environment configuration..."
        
        # Check if .env.example exists
        if [ -f ".env.example" ]; then
          echo "âœ… .env.example exists"
          
          # Check for required variables
          if grep -q "OPENAI_API_KEY" .env.example; then
            echo "âœ… OpenAI API key configuration"
          fi
          
          if grep -q "HUGGINGFACE_API_KEY" .env.example; then
            echo "âœ… HuggingFace API key configuration"
          fi
        fi

  final-approval:
    name: Final Approval
    runs-on: ubuntu-latest
    needs: [validate-pr, test-integration, documentation-check, security-scan]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Generate approval message
      run: |
        echo "ğŸ¯ Pull Request Validation Complete!"
        echo "=================================="
        echo ""
        echo "âœ… All validation checks passed"
        echo "âœ… Integration tests successful"
        echo "âœ… Documentation validated"
        echo "âœ… Security scan completed"
        echo ""
        echo "ğŸš€ This PR is ready for merge!"
        echo ""
        echo "ğŸ“‹ Summary:"
        echo "- Code quality: âœ… Passed"
        echo "- Tests: âœ… Passed (${{ needs.validate-pr.outputs.test_count }} tests)"
        echo "- Security: âœ… Passed"
        echo "- Documentation: âœ… Complete"
        echo "- Performance: âœ… Benchmarks met"
        echo ""
        echo "ğŸ”— PR URL: ${{ github.event.pull_request.html_url }}"
        echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
        echo "ğŸ“… Date: $(date -u)"
        
        # Create approval comment
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{
            "body": "ğŸ‰ **Pull Request Approved!**\n\nâœ… All validation checks passed\nâœ… Integration tests successful\nâœ… Documentation validated\nâœ… Security scan completed\n\nğŸš€ This PR is ready for merge!\n\nğŸ“‹ Summary:\n- Code quality: âœ… Passed\n- Tests: âœ… Passed\n- Security: âœ… Passed\n- Documentation: âœ… Complete\n- Performance: âœ… Benchmarks met\n\nğŸ”— PR URL: ${{ github.event.pull_request.html_url }}\nğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}\nğŸ“… Date: '$(date -u)'"
          }' \
          "${{ github.event.pull_request.comments_url }}"